!function(e,t){"function"==typeof define&&define.amd?define(t):"object"==typeof exports?module.exports=t(require,exports,module):e.audioWave=t()}(this,function(){var e=window,t=function(){},n=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||function(t){e.setTimeout(t,1e3/60)},o=t,r=o.prototype;return r.init=function(e){var n,o=this;return e=e||{},e.selector?(o.opts=e,o.selector=e.selector,o.fps=e.fps||60,o.onError=e.onError||t,o.onMouseover=e.onMouseover||t,o.onMouseout=e.onMouseout||t,o.onUpdate=e.onUpdate||t,o.buflen=e.buflen||1024,o.buf=new Uint8Array(o.buflen),n=o.initRender().setupStream(),n&&n.loop(),o):o},r.loop=function(){var e=this,t=1e3/e.fps,o=+new Date;return function r(){n(r);var a=+new Date,i=a-o;i>t&&(o=a-i%t,e.updateRender())}()},r.initRender=function(){var e=this;return e.wrap=d3.select(e.selector),e.width=parseFloat(e.opts.width||e.wrap.style("width")),e.height=parseFloat(e.opts.height||e.wrap.style("height")),e.xScale=d3.scale.linear().domain([0,e.buflen]).rangeRound([0,e.width]),e.yScale=d3.scale.linear().domain([0,255]).rangeRound([e.height,0]),e.waveforms=e.wrap.append("svg").attr({width:e.width,height:e.height}).on({mouseover:function(t){e.onMouseover.call(e,t)},mouseout:function(t){e.onMouseout.call(e,t)}}).append("g").style("stroke","#fff").style("stroke-width",1).selectAll("line").data(e.buf).enter().append("line"),e},r.setupStream=function(){var n=this,o=navigator,r=e.AudioContext||e.webkitAudioContext,a=o.getUserMedia||o.webkitGetUserMedia||o.mozGetUserMedia;if(!r||!a)return n.onError();r=new r,n.analyser=r.createAnalyser(),n.analyser.fftSize=n.buflen;try{a.call(o,{audio:!0},function(e){r.createMediaStreamSource(e).connect(n.analyser)},t)}catch(i){return n.onError()}return n},r.updateRender=function(){var e=this;if(e.analyser)return e.analyser.getByteTimeDomainData(e.buf),e.waveforms&&e.waveforms.data(e.buf).attr({x1:function(t,n){return e.xScale(n>0?n-1:0)},y1:function(t,n){return e.yScale(n>0?e.buf[n-1]:e.buf[n])},x2:function(t,n){return e.xScale(n)},y2:function(t){return e.yScale(t)}}),e.onUpdate.call(e,e.buf),e},"undefined"==typeof module||"undefined"==typeof module.exports?o:void(module.exports=o)});